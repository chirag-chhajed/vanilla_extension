let k=(t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce((o,e)=>(e&=63,e<36?o+=e.toString(36):e<62?o+=(e-26).toString(36).toUpperCase():e>62?o+="-":o+="_",o),""),d,p=document.querySelector("div.form-container");chrome.runtime.sendMessage({action:"getData"},t=>{t?(console.log("Received data from background:"),d=t,console.log(t),v(d)):console.error("Failed to retrieve data from background")});function V(t){const o=new URL(chrome.runtime.getURL("/_favicon/"));return o.searchParams.set("pageUrl",t),o.searchParams.set("size","32"),o.toString()}async function B(t,o){const e=new AbortController,n=setTimeout(()=>e.abort(),o);try{const a=await fetch(t,{signal:e.signal});return clearTimeout(n),a}catch(a){throw clearTimeout(n),a}}async function _(t){try{const o=await B(t,1e4);if(console.log(o),!o.ok)throw new Error(`HTTP error! Status: ${o.status}`);const e=await o.text(),a=new DOMParser().parseFromString(e,"text/html"),s=a.querySelector("title").textContent,c=a.querySelector('meta[name="description"]'),l=c?c.getAttribute("content"):"";return console.log(s,l),{title:s,description:l}}catch(o){return console.error("Error fetching or parsing content:",o),{title:"",description:""}}}const C=document.getElementById("form"),i=document.getElementById("url"),r=document.getElementById("title"),u=document.getElementById("description"),f=document.getElementById("isPinned");let h;i.addEventListener("input",async function(){clearTimeout(h),h=setTimeout(async()=>{let t=i.value.trim();if(console.log(t),!t.startsWith("https://")&&!t.startsWith("http://")&&!t.startsWith("www.")&&(t=`https://${t}`),t){const{title:o,description:e}=await _(t);r.value=o,u.value=e,i.value=t}else r.value="",u.value=""},1e3)});C.addEventListener("submit",function(t){t.preventDefault();const o=i.value,e=r.value,n=u.value,a=f.checked,s=V(o);_(o);const c={id:k(),url:o,titleValue:e,descriptionValue:n,img:s,isPin:a,updatedAt:new Date,createdAt:new Date};chrome.runtime.sendMessage({action:"addData",data:c},l=>{l.success?(console.log("Data added to IndexedDB successfully"),i.value="",r.value="",u.value="",f.checked=!1,chrome.runtime.sendMessage({action:"getData"},m=>{m?(console.log("Received data from background:"),console.log(m),v(m),H("Link added successfully",3e3,"success"),p.classList.toggle("visible")):console.error("Failed to retrieve data from background")})):console.error("Failed to add data to IndexedDB")})});function T(t){console.log("Deleting data with ID:",t),chrome.runtime.sendMessage({action:"deleteData",id:t},o=>{o.success?(console.log("Data deleted successfully"),chrome.runtime.sendMessage({action:"getData"},e=>{e?(console.log("Received data from background:"),d=e,console.log(e),v(d)):console.error("Failed to retrieve data from background")})):console.error("Failed to delete data")})}const y=document.querySelector("body > main"),g=document.querySelector(".update-form-container"),D=document.getElementById("update-url"),b=document.getElementById("update-title"),I=document.getElementById("update-description"),L=document.getElementById("update-isPinned"),E=document.getElementById("update-id");function v(t){const o=t.map(e=>`
      <div class="card">
        <div class="card__img">
          <img src="${e.img}" alt="" />
        </div>
        <div class="card__content">
          <a target="_blank" href="${e.url}" class="card__link"><h3 title="${e.titleValue}" class="card__title">${e.titleValue}</h3></a>
          <p title="${e.descriptionValue}" class="card__description">${e.descriptionValue}</p>
          <div class="card__buttons">
            <button class="card__delete" data-id="${e.id}">
  <svg data-id="${e.id}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path data-id="${e.id}" d="M7 6V3C7 2.44772 7.44772 2 8 2H16C16.5523 2 17 2.44772 17 3V6H22V8H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V8H2V6H7ZM9 4V6H15V4H9Z"></path>
  </svg>
</button>
<button class="card__edit" data-id="${e.id}">
  <svg data-id="${e.id}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path data-id="${e.id}" d="M12.8995 6.85431L17.1421 11.0969L7.24264 20.9964H3V16.7538L12.8995 6.85431ZM14.3137 5.44009L16.435 3.31877C16.8256 2.92825 17.4587 2.92825 17.8492 3.31877L20.6777 6.1472C21.0682 6.53772 21.0682 7.17089 20.6777 7.56141L18.5563 9.68273L14.3137 5.44009Z"></path>
  </svg>
</button>
          </div>

        </div>
      </div>
    `);y.innerHTML=o.join(""),y.addEventListener("click",async e=>{const n=e.target;if(console.log(n),n.classList.contains("card__delete")||n.closest(".card__delete svg")||n.closest(".card__delete path")){const a=n.getAttribute("data-id");console.log("Deleting item with ID:",a),n.disabled=!0;try{T(a),console.log("Deletion finished successfully.")}catch(s){console.error("Error while deleting:",s)}n.disabled=!1}else if(n.classList.contains("card__edit")||n.closest(".card__edit svg")||n.closest(".card__edit path")){const a=n.getAttribute("data-id");console.log("Editing item with ID:",a);const s=t.find(c=>c.id===a);console.log(s),s&&(g.classList.toggle("visible"),D.value=s.url,b.value=s.titleValue,I.value=s.descriptionValue,L.checked=s.isPin,E.value=s.id)}})}let $=document.querySelector("button.button");$.addEventListener("click",()=>{p.classList.toggle("visible")});let M=document.querySelector("span.close-button");M.addEventListener("click",()=>{console.log("clicked"),p.classList.toggle("visible")});let S=document.querySelector("span.close-button-update");S.addEventListener("click",()=>{console.log("clicked"),g.classList.toggle("visible")});const w=document.getElementById("toast-container");function H(t,o,e){const n=document.createElement("div");n.classList.add("toast",e),n.textContent=t,w.appendChild(n),n.offsetHeight,n.style.opacity="1",setTimeout(()=>{n.style.opacity="0",n.addEventListener("transitionend",()=>{w.removeChild(n)})},o)}g.addEventListener("submit",async function(t){t.preventDefault();const o=E.value,e={url:D.value,titleValue:b.value,descriptionValue:I.value,isPin:L.checked,updatedAt:new Date};chrome.runtime.sendMessage({action:"updateData",data:e,id:o},n=>{console.log(n,"response"),n.success?(console.log("Data updated successfully"),g.classList.toggle("visible")):console.error("Failed to update data")})});
